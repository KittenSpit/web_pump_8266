<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Doser</title>
<style>
  :root{--bg:#f8fafc;--card:#fff;--b:#e5e7eb;--txt:#111827;--mut:#6b7280;--acc:#2563eb}
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Arial;background:var(--bg);color:var(--txt);margin:16px}
  h1{margin:8px 0 12px}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:14px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label{font-size:12px;color:var(--mut)}
  input,select,button,textarea{font:inherit;border:1px solid var(--b);border-radius:10px;padding:8px 10px}
  button{cursor:pointer;background:#fff}
  button.primary{background:var(--acc);color:#fff;border-color:var(--acc)}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid var(--b);padding:6px;text-align:center;font-size:14px}
  .mut{color:var(--mut);font-size:12px}
  .pill{display:inline-block;padding:4px 8px;border:1px solid var(--b);border-radius:999px;font-size:12px}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
</style>

<h1>ESP32 Doser</h1>
<div class="grid">
  <div class="card">
    <h3>Status</h3>
    <div  id="statusArea" class="mut">connecting...</div>
    <div class="mut"><br>Next run per pump updates live. Times are local.</div>
  </div>

  <div class="card">
    <h3>Wi-Fi / System</h3>
    <div class="row">
      <label>Hostname</label>
      <input id="hostname" placeholder="placeholder">
    </div>
    <div class="row">
      <label>SSID</label>
      <input id="ssid" placeholder="YOUR_WIFI">
    </div>
    <div class="row">
      <label>Password</label>
      <input id="pass" placeholder="YOUR_PASSWORD">
    </div>
    <div class="row">
      <button onclick="saveSettings()" class="primary">Save Settings</button>
      <span class="mut">Reboot after Wi-Fi changes.</span>
    </div>
  </div>
</div>

<div class="grid" id="pumpCards"></div>

<script>
let settings = null;
let lastStatus = null;
const NUM_PUMPS = 3;
const MAX_TIMES = 8;

function secToHHMM(sec){
  let h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60);
  return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');
}
function HHMMtoSec(hhmm){
  const [h,m] = hhmm.split(':').map(x=>parseInt(x||'0',10));
  return (h*3600 + m*60) | 0;
}

function pumpCard(i){
  return `
  <div class="card" id="pump${i}">
    <h3>Pump ${i}</h3>
    <div class="row">
      <label>ml/sec</label><input id="mlps_${i}" type="number" step="0.01" min="0" style="width:90px">
      <label>Duty</label><input id="duty_${i}" type="number" min="0" max="255" style="width:80px">
      <label>Run (s)</label><input id="runsec_${i}" type="number" min="1" max="600" style="width:90px">
      <label>Forward</label>
      <select id="dir_${i}">
        <option value="1">Normal</option>
        <option value="0">Reverse</option>
      </select>
    </div>

    <div class="row">
      <button onclick="doRun(${i})" class="primary">Run</button>
      <button onclick="doPrime(${i})">Prime</button>
      <button onclick="doPurge(${i})">Purge</button>
      <button onclick="doStop(${i})">Stop</button>
      <span class="pill" id="next_${i}">next: â€”</span>
    </div>

    <table>
      <thead><tr><th>#</th><th>Time</th><th>mL</th><th>Del</th></tr></thead>
      <tbody id="tbody_${i}">
        ${Array.from({length:MAX_TIMES}).map((_,t)=>`
          <tr>
            <td>${t+1}</td>
            <td><input id="time_${i}_${t}" type="time" value="00:00"></td>
            <td><input id="dose_${i}_${t}" type="number" min="0" step="0.1" style="width:90px" value="0"></td>
            <td><button onclick="delTime(${i},${t})">xx</button></td>
          </tr>
        `).join('')}
      </tbody>
    </table>

    <div class="row">
      <button onclick="saveSettings()" class="primary">Save Pump ${i}</button>
      <span class="mut">Only rows with mL &gt; 0 are stored.</span>
    </div>
  </div>`;
}

function renderPumpCards(){
  document.getElementById('pumpCards').innerHTML =
    Array.from({length:NUM_PUMPS}).map((_,i)=>pumpCard(i)).join('');
}

function fillSettingsUI(){
  if (!settings) return;
  hostname.value = settings.hostname || '';
  ssid.value = settings.wifi?.ssid || '';
  pass.value = settings.wifi?.pass || '';

  settings.pumps.forEach(p=>{
    document.getElementById('mlps_'+p.idx).value = p.mlPerSec;
    document.getElementById('duty_'+p.idx).value = p.duty;
    document.getElementById('runsec_'+p.idx).value = p.defaultRunSec || 5;
    document.getElementById('dir_'+p.idx).value = p.dirForward?1:0;

    // clear
    for(let t=0;t<MAX_TIMES;t++){
      document.getElementById(`time_${p.idx}_${t}`).value = '00:00';
      document.getElementById(`dose_${p.idx}_${t}`).value = 0;
    }
    (p.times||[]).forEach((o,ix)=>{
      if (ix<MAX_TIMES){
        document.getElementById(`time_${p.idx}_${ix}`).value = secToHHMM(o.sec||0);
        document.getElementById(`dose_${p.idx}_${ix}`).value = o.ml||0;
      }
    });
  });
}

function delTime(i,t){
  document.getElementById(`time_${i}_${t}`).value = '00:00';
  document.getElementById(`dose_${i}_${t}`).value = 0;
}

async function loadSettings(){
  const r = await fetch('/api/settings');
  settings = await r.json();
  fillSettingsUI();
}

async function saveSettings(){
  // collect
  const out = {
    hostname: hostname.value,
    wifi: { ssid: ssid.value, pass: pass.value },
    pumps: []
  };
  for (let i=0;i<NUM_PUMPS;i++){
    const times=[];
    for (let t=0;t<MAX_TIMES;t++){
      const hhmm = document.getElementById(`time_${i}_${t}`).value || "00:00";
      const ml = parseFloat(document.getElementById(`dose_${i}_${t}`).value||"0");
      if (ml>0){
        times.push({sec: HHMMtoSec(hhmm), ml});
      }
    }
    out.pumps.push({
      idx:i,
      mlPerSec: parseFloat(document.getElementById('mlps_'+i).value||"1"),
      duty: parseInt(document.getElementById('duty_'+i).value||"200"),
      defaultRunSec: parseInt(document.getElementById('runsec_'+i).value||"5"),
      dirForward: parseInt(document.getElementById('dir_'+i).value||"1"),
      times
    });
  }
  const r = await fetch('/api/settings', {method:'POST', body: JSON.stringify(out)});
  if (r.ok) alert('Saved!');
  else alert('Save failed');
}

async function postJSON(url,obj){
  return fetch(url,{method:'POST', body: JSON.stringify(obj)});
}
function doRun(i){ postJSON('/api/run',   {idx:i}); }
function doPrime(i){ postJSON('/api/prime',{idx:i,sec:3}); }
function doPurge(i){ postJSON('/api/purge',{idx:i,sec:2}); }
function doStop(i){ postJSON('/api/stop', {idx:i}); }

function applyStatus(s){
  lastStatus = s;
  const lines = [];
  s.pumps.forEach(p=>{
    const msLeft = Math.max(0, (p.start_ms + p.dur_ms) - s.uptime_ms);
    const secLeft = Math.ceil(msLeft/1000);
    const nextTxt = (p.next_run_s<0) ? 'na' : `${Math.floor(p.next_run_s/3600)}h ${Math.floor((p.next_run_s%3600)/60)}m`;
 
    lines.push(
      `Pump ${p.idx}: ${p.running?'RUNNING -> '+secLeft+'s': 'idle'} | `+
      `delivered ~${p.delivered_ml.toFixed(1)} ml | next ${nextTxt}`
    );
    const pill = document.getElementById('next_'+p.idx);
    if (pill) pill.textContent = `next: ${nextTxt}`;
  });
  statusArea.innerHTML = lines.join('<br>');
}

let sock=null;
function connectWS(){
  sock = new WebSocket(`ws://${location.host}/ws`);
  sock.onopen = ()=> { /* auto status push every 1s */ };
  sock.onmessage = (ev)=> {
    try{ applyStatus(JSON.parse(ev.data)); }catch(e){}
  };
  sock.onclose = ()=> setTimeout(connectWS, 1000);
}

renderPumpCards();
loadSettings();
connectWS();
</script>
