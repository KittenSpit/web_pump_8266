<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doser Log Viewer</title>
  <!--
    Doser Log Viewer (single-file, no libraries)
    Endpoints (hard-coded):
      - GET  /api/log.json   -> JSON log entries
      - GET  /api/log/csv    -> raw CSV download from device
      - POST /api/log_clear  -> clears log on device

    Your example JSON matches this mapper:
      ts:    "2025-09-22 00:34:11" (local clock string)  âœ… handled
      event: "Prime|Run|Stop|Purge"                     âœ… normalized to lowercase
      pump:  0..N                                       âœ…
      ml:    number                                     âœ…
      runtime: seconds                                  âœ… mapped to dur_ms
      uptime_ms, duty, dir, mlps                        âœ… kept in _raw

    Deploy: save as /data/index.html (LittleFS), or serve as /log.html.
  -->
  <style>
    :root{
      --bg:#0b1220; --panel:#111827; --mut:#95a3b5; --txt:#eaf1f7; --acc:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --b:#223044;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1a);color:var(--txt);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
    h1{font-size:20px;font-weight:700;margin:0 0 12px 0;letter-spacing:.2px}
    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;background:var(--panel);border:1px solid var(--b);border-radius:12px;padding:10px}
    .bar .sp{flex:1}
    .btn{appearance:none;border:1px solid var(--b);background:#0e1626;color:var(--txt);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#2e3d57;transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.warn{background:#1c1406;border-color:#3a2a10;color:#ffd89a}
    .btn.warn:hover{border-color:#6b4b16}
    .btn.ok{background:#082010;border-color:#173a26;color:#b6ffcc}
    input, select{background:#0e1626;border:1px solid var(--b);color:var(--txt);padding:8px 10px;border-radius:10px;min-width:120px}
    input::placeholder{color:#8aa}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--b);background:#0e1626}
    .mut{color:var(--mut)}
    .card{margin-top:12px;background:var(--panel);border:1px solid var(--b);border-radius:12px;overflow:hidden}

    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:#0f1729;border-bottom:1px solid var(--b);font-weight:700;text-align:left;padding:10px}
    tbody td{border-top:1px solid #122; padding:8px 10px; vertical-align:top}
    tbody tr:hover{background:#111a2b}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .grid{display:grid;grid-template-columns: repeat(7, minmax(0,1fr));gap:8px}
    @media (max-width: 900px){ .grid{grid-template-columns: repeat(2, minmax(0,1fr));} }

    .footer{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:10px}
    .sum b{font-weight:800}
    .tag-ok{color:var(--ok)}
    .tag-warn{color:var(--warn)}
    .tag-err{color:var(--err)}
    .th-sort{cursor:pointer}
    .th-sort .dir{opacity:.7;font-size:11px;margin-left:6px}
    .empty{padding:18px;color:#9ab}

    .qr{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .qr .btn{padding:6px 10px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Doser Log Viewer</h1>

    <div class="bar">
      <button class="btn" id="btnRefresh" title="Fetch /api/log.json">âŸ³ Refresh</button>
      <a class="btn" id="btnCsvRaw" href="/api/log.csv" download>â¬‡ Raw CSV</a>
      <button class="btn" id="btnCsvFiltered" title="Export filtered rows to CSV">â¬‡ Export Filtered</button>
      <span class="sp"></span>
      <span class="pill">Rows: <span id="rowCount" class="kbd">0</span></span>
      <span class="pill">Total ml: <span id="mlTotal" class="kbd">0.0</span></span>
      <span class="pill">Last updated: <span id="lastUpd" class="kbd">â€”</span></span>
      <button class="btn warn" id="btnClear" title="POST /api/log_clear">ðŸ—‘ Clear Log</button>
    </div>

    <div class="card" style="padding:10px 10px 2px 10px">
      <div id="errBox" style="display:none;background:#1b140e;border:1px solid #553;border-radius:8px;padding:10px;margin-bottom:8px">
        <div style="color:#ffd9a8;">âš  <b>Problem loading log</b> â€” check CORS, JSON validity, or BASE.
          <pre id="errText" class="kbd" style="white-space:pre-wrap"></pre>
          <div class="mut">If this page is not served from the device, set <code>BASE</code> at the top of the script (e.g., <code>http://192.168.1.98</code>).</div>
        </div>
      </div>
      <div class="grid">
        <input id="fText" placeholder="Search text / status / event" />
        <select id="fPump">
          <option value="">Pump: All</option>
          <option>0</option><option>1</option><option>2</option><option>3</option>
        </select>
        <select id="fEvent">
          <option value="">Event: Any</option>
          <option value="prime">prime</option>
          <option value="run">run</option>
          <option value="stop">stop</option>
          <option value="purge">purge</option>
          <option value="info">info</option>
          <option value="warn">warn</option>
          <option value="err">err</option>
        </select>
        <input id="fFrom" type="datetime-local" />
        <input id="fTo" type="datetime-local" />
        <button class="btn" id="btnClearFilters">Reset Filters</button>
        <div class="qr">
          <span class="mut">Quick range:</span>
          <button class="btn" data-range="1h">1h</button>
          <button class="btn" data-range="6h">6h</button>
          <button class="btn" data-range="24h">24h</button>
          <button class="btn" data-range="today">Today</button>
          <button class="btn" data-range="7d">7d</button>
          <button class="btn" data-range="30d">30d</button>
          <button class="btn" data-range="all">All</button>
        </div>
      </div>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th class="th-sort" data-k="t">Time<span class="dir"></span></th>
            <th class="th-sort" data-k="pump">Pump<span class="dir"></span></th>
            <th class="th-sort" data-k="event">Event<span class="dir"></span></th>
            <th class="th-sort" data-k="ml">ml<span class="dir"></span></th>            
            <th class="th-sort" data-k="dur">Duration<span class="dir"></span></th>            
            <th class="th-sort" data-k="mlps">ml/s<span class="dir"></span></th>
            <th class="th-sort" data-k="duty">Duty<span class="dir"></span></th>
            <th class="th-sort" data-k="status">Status<span class="dir"></span></th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td class="empty" colspan="7">No data. Click <b>Refresh</b>.</td></tr></tbody>
      </table>
    </div>

    <div class="footer">
      <div class="sum" id="summary"></div>
      <div class="mut">Tips: click headers to sort â€¢ filters persist â€¢ quick ranges set From/To for you</div>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    // If this HTML is hosted OFF the device, set BASE to the device origin to avoid CORS.
    // Example: const BASE = 'http://192.168.1.98'; Leave '' when served from the device itself.
    const BASE = '';
    const fmtClock = d => d.toLocaleString([], {hour12:false});
    const pad = n => String(n).padStart(2,'0');
    const msToHMS = ms => {
      if (ms == null) return 'â€”';
      const s = Math.round(ms/1000);
      const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss=s%60;
      return (h? h+':':'') + pad(m) + ':' + pad(ss);
    };

    // Parse timestamps robustly; also accepts "YYYY-MM-DD HH:mm:ss" as LOCAL time
    function parseLocalish(ts){
      if (typeof ts === 'number') return ts < 1e12 ? ts*1000 : ts; // epoch seconds or ms
      if (typeof ts === 'string'){
        // normalize space to 'T' so the browser treats it as local time (per spec)
        const s = ts.includes(' ') && !ts.includes('T') ? ts.replace(' ', 'T') : ts;
        const t = Date.parse(s);
        if (!Number.isNaN(t)) return t;
      }
      return NaN;
    }

    function normalize(e){
      const ev = (e.event ?? e.type ?? e.action ?? '').toString().toLowerCase();
      const runtime_s = Number(e.runtime ?? e.runtime_s ?? NaN);
      const dur_ms = Number.isFinite(runtime_s) ? Math.round(runtime_s*1000) : (e.dur_ms ?? e.duration_ms ?? e.ms ?? NaN);
      return {
        t: parseLocalish(e.ts ?? e.time ?? e.when ?? e.timestamp ?? e.date),
        pump: e.pump ?? e.idx ?? e.pump_idx ?? null,
        event: ev,
        ml: Number(e.ml ?? e.delivered_ml ?? e.amount_ml ?? NaN),
        dur: Number(dur_ms),
        mlps: Number(e.mlps),
        duty: Number(e.duty),
        status: (e.status ?? e.level ?? '').toString(),
        note: (e.msg ?? e.note ?? e.details ?? e.text ?? '').toString(),
        _raw: e
      };
    }

    function loadFilters(){
      try{
        const j = JSON.parse(localStorage.getItem('logFilters')||'{}');
        if (j.text) $('#fText').value = j.text;
        if (j.pump !== undefined) $('#fPump').value = j.pump;
        if (j.event) $('#fEvent').value = j.event;
        if (j.from) $('#fFrom').value = j.from;
        if (j.to) $('#fTo').value = j.to;
      }catch{}
    }
    function saveFilters(){
      const j = {text:$('#fText').value.trim(), pump:$('#fPump').value, event:$('#fEvent').value, from:$('#fFrom').value, to:$('#fTo').value};
      localStorage.setItem('logFilters', JSON.stringify(j));
    }

    // ---------- State ----------
    let rows = [];         // normalized rows
    let sortKey = 't';
    let sortDir = 1;      // -1 desc, +1 asc

    // ---------- Fetch ----------
async function fetchJson() {
  const url = BASE + '/api/log.json?t=' + Date.now();
  let respText = '';
  try {
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) throw new Error('HTTP ' + r.status);

    // read as text, strip BOM if present, then parse
    respText = await r.text();
    const clean = respText.replace(/^\uFEFF/, '').trim();
    const j = JSON.parse(clean);

    // normalize array
    let arr = Array.isArray(j) ? j : (j.logs || j.entries || j.items || j.data || []);
    if (!Array.isArray(arr)) arr = [];

    rows = arr.map(normalize).filter(r => !Number.isNaN(r.t));
    hideError?.();
    render();
    $('#lastUpd').textContent = new Date().toLocaleTimeString();
  } catch (e) {
    showError?.(
      'Fetch/parse failed: ' + e.message +
      (respText ? `\nFirst 200 chars: ${respText.slice(0, 200)}` : '')
    );
    throw e;
  }
}
    // ---------- Filter + Sort ----------
    function applyFilters(list){
      const text = $('#fText').value.trim().toLowerCase();
      const pump = $('#fPump').value;
      const ev = $('#fEvent').value;
      const from = $('#fFrom').value ? Date.parse($('#fFrom').value) : null;
      const to   = $('#fTo').value   ? Date.parse($('#fTo').value)   : null;

      return list.filter(r=>{
        if (!Number.isFinite(r.t)) return false;
        if (from!=null && r.t < from) return false;
        if (to!=null   && r.t > to)   return false;
        if (pump!=='' && String(r.pump)!==pump) return false;
        if (ev!=='' && r.event!==ev) return false;
        if (text){
          const blob = `${r.note} ${r.status} ${r.event}`.toLowerCase();
          if (!blob.includes(text)) return false;
        }
        return true;
      });
    }

    function render(){
      const data = applyFilters(rows).sort((a,b)=>{
        const ka = a[sortKey]; const kb = b[sortKey];
        if (ka==null && kb==null) return 0;
        if (ka==null) return 1; if (kb==null) return -1;
        if (ka<kb) return -1*sortDir; if (ka>kb) return 1*sortDir; return 0;
      });

      const tbody = $('#tbody');
      tbody.innerHTML = '';
      if (data.length===0){
        tbody.innerHTML = '<tr><td class="empty" colspan="7">No matching rows.</td></tr>';
      } else {
        const frag = document.createDocumentFragment();
        for (const r of data){
          const tr = document.createElement('tr');
          const t = new Date(r.t);
          tr.innerHTML = `
            <td class="kbd" title="${t.toISOString()}">${fmtClock(t)}</td>
            <td class="kbd">${r.pump ?? 'â€”'}</td>
            <td class="kbd ${r.event==='err'?'tag-err': r.event==='warn'?'tag-warn': r.event==='prime' || r.event==='run' ? 'tag-ok':''}">${r.event||'â€”'}</td>
            <td class="kbd">${Number.isFinite(r.ml)? r.ml.toFixed(2): 'â€”'}</td>
            <td class="kbd" title="${r.dur??''} ms">${Number.isFinite(r.dur)? msToHMS(r.dur): 'â€”'}</td>
            <td class="kbd">${r.mlps ?? 'â€”'}</td>
            <td class="kbd">${r.duty ?? 'â€”'}</td>
            <td class="kbd">${r.status||'â€”'}</td>
            <td>${r.note? r.note.replace(/[]+/g,' '): ''}</td>
          `;
          frag.appendChild(tr);
        }
        tbody.appendChild(frag);
      }

      // stats
      const mlSum = data.reduce((acc,r)=>acc + (Number.isFinite(r.ml)? r.ml:0), 0);
      $('#rowCount').textContent = String(data.length);
      $('#mlTotal').textContent = mlSum.toFixed(2);
      $('#summary').innerHTML = `Showing <b>${data.length}</b> rows. <span class=\"mut\">Sorted by <code>${sortKey}</code> ${sortDir===-1?'â–¼':'â–²'}.</span>`;

      // header sort arrows
      document.querySelectorAll('.th-sort .dir').forEach(el=>el.textContent='');
      const active = document.querySelector(`.th-sort[data-k="${sortKey}"] .dir`);
      if (active) active.textContent = sortDir===-1 ? 'â–¼' : 'â–²';
    }

    function onHeaderClick(ev){
      const th = ev.target.closest('.th-sort');
      if (!th) return;
      const k = th.dataset.k;
      if (sortKey === k) sortDir *= -1; else { sortKey = k; sortDir = (k==='t'||k==='pump')?-1:1; }
      render();
    }

    // ---------- Quick Ranges ----------
    function setRange(kind){
      const now = new Date();
      let from=null, to=null;
      const setInput = d => d ? new Date(d - d.getTimezoneOffset()*60000).toISOString().slice(0,16) : '';

      switch(kind){
        case '1h': from = new Date(now.getTime()-3600e3); to = now; break;
        case '6h': from = new Date(now.getTime()-6*3600e3); to = now; break;
        case '24h': from = new Date(now.getTime()-24*3600e3); to = now; break;
        case 'today': {
          const start = new Date(now); start.setHours(0,0,0,0);
          from = start; to = now; break;
        }
        case '7d': from = new Date(now.getTime()-7*86400e3); to = now; break;
        case '30d': from = new Date(now.getTime()-30*86400e3); to = now; break;
        case 'all': default: from = null; to = null; break;
      }
      $('#fFrom').value = from? setInput(from): '';
      $('#fTo').value = to? setInput(to): '';
      saveFilters();
      render();
    }

    // ---------- Export filtered CSV ----------
/*     function csvEscape(s){
      if (s==null) return '';
      const str = String(s);
      if (/[",]/.test(str)) return '"' + str.replace(/"/g,'""') + '"';
      return str;
    } */
// robust CSV escaper (keeps quotes/commas/newlines safe)
function csvEscape(v){
  if (v === null || v === undefined) return '';
  const s = String(v);
  return /[",\r\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
}

    function exportFilteredCSV(){
      const data = applyFilters(rows).sort((a,b)=>{
        const ka=a[sortKey], kb=b[sortKey];
        if (ka<kb) return -1*sortDir; if (ka>kb) return 1*sortDir; return 0;
      });
      const header = ['time_local','time_iso','pump','event','ml','dur_ms','mlps','duty','status','note'];
      //const lines = [header.join(',')];
        const lines  = [header.map(csvEscape).join(',')];
      for (const r of data){
        const d = new Date(r.t);
        lines.push([
          fmtClock(d),
          d.toISOString(),
          r.pump ?? '',
          r.event ?? '',
         // Number.isFinite(r.ml)? r.ml.toFixed(3): '',
         // Number.isFinite(r.dur)? r.dur: '',
      Number.isFinite(r.ml)  ? r.ml.toFixed(3) : '',  // ml
      Number.isFinite(r.dur_ms) ? r.dur_ms : (Number.isFinite(r.dur) ? r.dur : ''), // dur_ms
        r.mlps ?? '',
        r.duty ?? '',

      //Number.isFinite(r.mlps)  ? r.mlps.toFixed(2) : '',  // mlps
      //Number.isFinite(r.duty)  ? r.duty.toFixed(0) : '',  // duty

          r.status ?? '',
          r.note ?? ''
 //       ].map(csvEscape).join(','));
     ].map(csvEscape).join(','));
      }
        // Use CRLF for Excel; prepend BOM for UTF-8 friendliness
  const csvText = '\uFEFF' + lines.join('\r\n');
  const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
     // const blob = new Blob([lines.join('\r\n')+''], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href = url; 
  a.download = `doser_log_filtered_${stamp}.csv`;
      document.body.appendChild(a); 
      a.click(); 
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    // ---------- Clear log ----------
    async function clearLog(){
      if (!confirm('Clear log on device?')) return;
      try{
        const r = await fetch(BASE + '/api/logs/clear', {method:'GET'});
        if (!r.ok) throw new Error('HTTP '+r.status);
        await fetchJson();
      }catch(e){
        alert('Failed to clear: '+e.message);
      }
    }

    async function clearLogWithConfirm(){
  if (!window.confirm('Really clear the log? This cannot be undone.')) return;

  const btn = document.getElementById('btnClear');
  const prevTxt = btn ? btn.textContent : null;
  if (btn) { btn.disabled = true; btn.textContent = 'Clearingâ€¦'; }

  try {
    if (typeof hideError === 'function') hideError();

    // Most APIs expect POST for a state-changing action.
    // If your endpoint is GET-only, change method to 'GET'.
    const resp = await fetch('/api/logs/clear', {
      method: 'GET',
      cache: 'no-store',
      headers: { 'Accept': 'application/json' }
    });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);

    // Optional: if server returns JSON {ok:true}, you can read it:
    // const j = await resp.json();

    // Clear local rows immediately (snappy UI), then re-fetch to confirm
    if (Array.isArray(window.rows)) {
      window.rows = [];
      if (typeof render === 'function') render();
    }
    if (typeof fetchJson === 'function') await fetchJson(); // refresh from /api/log.json
  } catch (e) {
    if (typeof showError === 'function') showError('Clear failed: ' + e.message);
    else console.error(e);
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = prevTxt; }
  }
}

    // ---------- Wire up ----------
    function showError(msg){ const b=$('#errBox'); $('#errText').textContent = msg; b.style.display='block'; }
    function hideError(){ const b=$('#errBox'); b.style.display='none'; }

    function init(){
      loadFilters();
      $('#btnRefresh').addEventListener('click', fetchJson);
      // Set raw CSV link respecting BASE
      const raw = document.getElementById('btnCsvRaw'); if (raw) raw.href = BASE + '/api/log.csv';
      $('#btnCsvFiltered').addEventListener('click', exportFilteredCSV);
      //const clr = document.getElementById('btnClear'); if (raw) raw.href = BASE + '/api/logs/clear';
     // $('#btnClear').addEventListener('click', clearLog);
      $('#btnClear').addEventListener('click', clearLogWithConfirm);
      
      $('#tbl thead').addEventListener('click', onHeaderClick);

      ['#fText','#fPump','#fEvent','#fFrom','#fTo'].forEach(sel=>{
        $(sel).addEventListener('input', ()=>{ saveFilters(); render(); });
        $(sel).addEventListener('change', ()=>{ saveFilters(); render(); });
      });

      document.querySelectorAll('.qr .btn').forEach(b=>{
        b.addEventListener('click', ()=> setRange(b.dataset.range));
      });

      // auto load once
      fetchJson().catch(()=>{});
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
